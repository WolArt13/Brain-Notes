<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Brain Notes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #1a1d2e;
            color: #e1e4ed;
            min-height: 100vh;
        }

        /* Хедер */
        .header {
            background: #252839;
            padding: 16px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #2d3142;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);
        }

        .btn-logout {
            background: rgba(244, 63, 94, 0.1);
            border: 1px solid rgba(244, 63, 94, 0.3);
            color: #f43f5e;
        }

        .btn-logout:hover {
            background: rgba(244, 63, 94, 0.2);
        }

        /* Контент */
        .container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 300px;
            background: #252839;
            border-right: 1px solid #2d3142;
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar-header {
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #e1e4ed;
        }

        .tree {
            list-style: none;
        }

        .tree-item {
            margin-bottom: 4px;
        }

        .tree-node {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            gap: 8px;
            position: relative;
            draggable: true;
        }

        .tree-node:hover {
            background: rgba(79, 172, 254, 0.1);
        }

        .tree-node.active {
            background: rgba(79, 172, 254, 0.2);
        }

        .tree-node.folder {
            font-weight: 500;
        }

        .tree-node.note {
            font-size: 0.9rem;
            padding-left: 28px;
        }

        .tree-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            font-size: 0.8rem;
            color: #9397ad;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .tree-toggle.open {
            transform: rotate(90deg);
        }

        .tree-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .tree-label {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tree-actions {
            display: none;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tree-node:hover .tree-actions {
            display: flex;
            opacity: 1;
        }

        .tree-action-btn {
            background: none;
            border: none;
            color: #9397ad;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 2px 4px;
            transition: all 0.2s;
        }

        .tree-action-btn:hover {
            color: #e1e4ed;
        }

        .tree-children {
            display: none;
            margin-left: 20px;
        }

        .tree-children.visible {
            display: block;
        }

        /* Контент область */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .content-header {
            padding: 20px 40px;
            border-bottom: 1px solid #2d3142;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .content-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #e1e4ed;
        }

        .content-body {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .editor {
            background: #252839;
            border: 1px solid #2d3142;
            border-radius: 16px;
            padding: 32px;
        }

        .editor-field {
            margin-bottom: 24px;
        }

        .editor-label {
            display: block;
            margin-bottom: 8px;
            color: #9397ad;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .editor-input,
        .editor-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #363b4e;
            border-radius: 10px;
            background: #2d3142;
            color: #e1e4ed;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s;
        }

        .editor-input:focus,
        .editor-textarea:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .editor-textarea {
            min-height: 300px;
            resize: vertical;
        }

        .editor-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-save {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: #fff;
        }

        .btn-cancel {
            background: rgba(255, 255, 255, 0.1);
            color: #9397ad;
        }

        .btn-delete {
            background: rgba(244, 63, 94, 0.1);
            color: #f43f5e;
            border: 1px solid rgba(244, 63, 94, 0.3);
            margin-left: auto;
        }

        .btn-delete:hover {
            background: rgba(244, 63, 94, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #9397ad;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 20px;
        }

        .empty-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #e1e4ed;
            margin-bottom: 12px;
        }

        /* Модальное окно */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #252839;
            border: 1px solid #363b4e;
            border-radius: 16px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #e1e4ed;
        }

        .modal-close {
            background: none;
            border: none;
            color: #9397ad;
            font-size: 1.8rem;
            cursor: pointer;
            line-height: 1;
        }

        .modal-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .modal-input {
            padding: 12px 16px;
            border: 1px solid #363b4e;
            border-radius: 10px;
            background: #2d3142;
            color: #e1e4ed;
            font-size: 1rem;
            font-family: inherit;
        }

        .modal-input:focus {
            outline: none;
            border-color: #4facfe;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 12px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        /* Drag and Drop */
        .tree-node.dragging {
            opacity: 0.5;
        }

        .tree-node.drag-over {
            background: rgba(79, 172, 254, 0.3);
            border-radius: 6px;
        }

        /* Note view mode */
        .note-view {
            padding: 40px;
            background: #252839;
            border-radius: 16px;
            border: 1px solid #2d3142;
        }

        .note-title {
            font-size: 2rem;
            font-weight: 700;
            color: #e1e4ed;
            margin-bottom: 16px;
        }

        .note-content {
            font-size: 1rem;
            line-height: 1.8;
            color: #cbd5e1;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .note-meta {
            margin-top: 32px;
            padding-top: 16px;
            border-top: 1px solid #363b4e;
            color: #9397ad;
            font-size: 0.85rem;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #9397ad;
        }
    </style>
</head>
<body>
    <!-- Хедер -->
    <div class="header">
        <div class="logo">Brain Notes</div>
        <div class="header-actions">
            <button class="btn btn-primary" id="newNoteBtn">📝 Новая заметка</button>
            <button class="btn btn-primary" id="newFolderBtn">📁 Новая папка</button>
            <button class="btn btn-logout" id="logoutBtn">Выйти</button>
        </div>
    </div>

    <!-- Контент -->
    <div class="container">
        <!-- Сайдбар -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">Папки и заметки</div>
            </div>
            <ul class="tree" id="treeContainer"></ul>
        </div>

        <!-- Основной контент -->
        <div class="main-content">
            <div class="content-header">
                <div class="content-title" id="contentTitle">Brain Notes</div>
            </div>
            <div class="content-body" id="contentBody">
                <div class="loading">Загрузка...</div>
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div class="modal" id="newNoteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Новая заметка</div>
                <button class="modal-close" onclick="closeNewNoteModal()">&times;</button>
            </div>
            <div class="modal-form">
                <input type="text" id="newNoteTitle" class="modal-input" placeholder="Название" />
                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button class="btn btn-primary" onclick="createNote()" style="flex: 1;">Создать</button>
                    <button class="btn btn-cancel" onclick="closeNewNoteModal()" style="flex: 1;">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="newFolderModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Новая папка</div>
                <button class="modal-close" onclick="closeNewFolderModal()">&times;</button>
            </div>
            <div class="modal-form">
                <input type="text" id="newFolderTitle" class="modal-input" placeholder="Название папки" />
                <div style="display: flex; gap: 12px; margin-top: 12px;">
                    <button class="btn btn-primary" onclick="createFolder()" style="flex: 1;">Создать</button>
                    <button class="btn btn-cancel" onclick="closeNewFolderModal()" style="flex: 1;">Отмена</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="confirmDeleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Подтверждение удаления</div>
            </div>
            <p id="deleteMessage" style="color: #cbd5e1; margin-bottom: 24px;"></p>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="closeConfirmDelete()" style="flex: 1;">Отмена</button>
                <button class="btn btn-delete" onclick="confirmDelete()" style="flex: 1;">Удалить</button>
            </div>
        </div>
    </div>

    <script>
        let currentItem = null;
        let tree = [];
        let deleteCallback = null;
        let refreshTokenInterval = null;
        let currentParentFolderId = null;

        // Обновление токена
        async function refreshAccessToken() {
            try {
                const response = await fetch('/auth/refresh', {
                    method: 'POST',
                    credentials: 'include'
                });
                if (!response.ok) {
                    window.location.href = '/auth/login';
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                window.location.href = '/auth/login';
            }
        }

        function startTokenRefresh() {
            if (refreshTokenInterval) clearInterval(refreshTokenInterval);
            refreshTokenInterval = setInterval(refreshAccessToken, 25 * 60 * 1000);
        }

        function stopTokenRefresh() {
            if (refreshTokenInterval) clearInterval(refreshTokenInterval);
        }

        // Загрузка дерева - POST /dashboard/tree
        async function loadTree() {
            try {
                const response = await fetch('/dashboard/tree', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({})
                });
                if (!response.ok) throw new Error('Ошибка загрузки дерева');
                tree = await response.json();
                renderTree();
            } catch (error) {
                console.error('Error loading tree:', error);
                showError('Ошибка загрузки структуры');
            }
        }

        // Рендер дерева
        function renderTree() {
            const container = document.getElementById('treeContainer');
            container.innerHTML = '';
            tree.forEach(item => {
                container.appendChild(renderTreeItem(item));
            });
        }

        function renderTreeItem(item) {
            const li = document.createElement('li');
            li.className = 'tree-item';
            li.setAttribute('data-id', item.id);
            li.setAttribute('data-type', item.type);

            const nodeDiv = document.createElement('div');
            nodeDiv.className = `tree-node ${item.type}`;
            nodeDiv.draggable = true;

            // Иконка раскрытия для папок
            if (item.type === 'folder' && item.children && item.children.length > 0) {
                const toggle = document.createElement('span');
                toggle.className = 'tree-toggle';
                toggle.textContent = '▶';
                toggle.onclick = (e) => {
                    e.stopPropagation();
                    toggleFolder(li);
                };
                nodeDiv.appendChild(toggle);
            } else if (item.type === 'folder') {
                const emptyToggle = document.createElement('span');
                emptyToggle.className = 'tree-toggle';
                emptyToggle.style.visibility = 'hidden';
                nodeDiv.appendChild(emptyToggle);
            }

            // Иконка
            const icon = document.createElement('span');
            icon.className = 'tree-icon';
            icon.textContent = item.type === 'folder' ? '📁' : '📄';
            nodeDiv.appendChild(icon);

            // Название
            const label = document.createElement('span');
            label.className = 'tree-label';
            label.textContent = item.title;
            label.onclick = () => selectItem(item);
            nodeDiv.appendChild(label);

            // Действия
            const actions = document.createElement('div');
            actions.className = 'tree-actions';

            if (item.type === 'note') {
                const editBtn = document.createElement('button');
                editBtn.className = 'tree-action-btn';
                editBtn.textContent = '✏️';
                editBtn.title = 'Редактировать';
                editBtn.onclick = (e) => {
                    e.stopPropagation();
                    selectItem(item);
                    enterEditMode();
                };
                actions.appendChild(editBtn);
            }

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'tree-action-btn';
            deleteBtn.textContent = '🗑️';
            deleteBtn.title = 'Удалить';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                showDeleteConfirm(item);
            };
            actions.appendChild(deleteBtn);

            nodeDiv.appendChild(actions);

            // Drag and Drop
            nodeDiv.ondragstart = (e) => {
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('itemId', item.id);
                e.dataTransfer.setData('itemType', item.type);
                nodeDiv.classList.add('dragging');
            };

            nodeDiv.ondragend = () => {
                nodeDiv.classList.remove('dragging');
                document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('drag-over'));
            };

            nodeDiv.ondragover = (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                nodeDiv.classList.add('drag-over');
            };

            nodeDiv.ondragleave = () => {
                nodeDiv.classList.remove('drag-over');
            };

            nodeDiv.ondrop = (e) => {
                e.preventDefault();
                nodeDiv.classList.remove('drag-over');
                const draggedId = e.dataTransfer.getData('itemId');
                const draggedType = e.dataTransfer.getData('itemType');

                if (draggedId === item.id) return;
                if (item.type === 'note') return;

                moveItem(draggedId, draggedType, item.id);
            };

            li.appendChild(nodeDiv);

            // Дочерние элементы
            if (item.type === 'folder' && item.children && item.children.length > 0) {
                const childrenDiv = document.createElement('div');
                childrenDiv.className = 'tree-children visible';
                const childList = document.createElement('ul');
                childList.className = 'tree';

                item.children.forEach(child => {
                    childList.appendChild(renderTreeItem(child));
                });

                childrenDiv.appendChild(childList);
                li.appendChild(childrenDiv);
            }

            return li;
        }

        function toggleFolder(li) {
            const childrenDiv = li.querySelector('.tree-children');
            const toggle = li.querySelector('.tree-toggle');

            if (!childrenDiv) return;

            childrenDiv.classList.toggle('visible');
            toggle.classList.toggle('open');
        }

        // Выбор элемента
        function selectItem(item) {
            document.querySelectorAll('.tree-node').forEach(n => n.classList.remove('active'));
            const treeNode = document.querySelector(`[data-id="${item.id}"] .tree-node`);
            if (treeNode) treeNode.classList.add('active');

            currentItem = item;
            renderContent(item);
        }

        // Рендер контента
        function renderContent(item) {
            const contentBody = document.getElementById('contentBody');
            const contentTitle = document.getElementById('contentTitle');

            contentTitle.textContent = item.title;

            if (item.type === 'folder') {
                contentBody.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">📁</div>
                        <div class="empty-title">${escapeHtml(item.title)}</div>
                        <div>Выберите заметку для просмотра</div>
                    </div>
                `;
                currentParentFolderId = item.id;
            } else {
                contentBody.innerHTML = `
                    <div class="note-view">
                        <div class="note-title">${escapeHtml(item.title)}</div>
                        <div class="note-content">${escapeHtml(item.content || '')}</div>
                        <div class="note-meta">Создано: ${new Date(item.created_at).toLocaleString('ru-RU')}</div>
                    </div>
                `;
                currentParentFolderId = null;
            }
        }

        // Режим редактирования
        function enterEditMode() {
            if (!currentItem || currentItem.type !== 'note') return;

            const contentBody = document.getElementById('contentBody');
            contentBody.innerHTML = `
                <div class="editor">
                    <div class="editor-field">
                        <label class="editor-label">Название</label>
                        <input type="text" id="editTitle" class="editor-input" value="${escapeHtml(currentItem.title)}" />
                    </div>
                    <div class="editor-field">
                        <label class="editor-label">Содержание</label>
                        <textarea id="editContent" class="editor-textarea">${escapeHtml(currentItem.content || '')}</textarea>
                    </div>
                    <div class="editor-actions">
                        <button class="btn btn-save" onclick="saveNote()">✅ Сохранить</button>
                        <button class="btn btn-cancel" onclick="cancelEdit()">❌ Отмена</button>
                        <button class="btn btn-delete" onclick="deleteCurrentNote()">🗑️ Удалить</button>
                    </div>
                </div>
            `;
        }

        function cancelEdit() {
            if (currentItem) renderContent(currentItem);
        }

        async function saveNote() {
            if (!currentItem || currentItem.type !== 'note') return;

            const title = document.getElementById('editTitle').value;
            const content = document.getElementById('editContent').value;

            try {
                const response = await fetch(`/dashboard/note/${currentItem.id}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ title, content })
                });

                if (!response.ok) throw new Error('Ошибка сохранения');

                currentItem.title = title;
                currentItem.content = content;
                renderContent(currentItem);
                loadTree();
            } catch (error) {
                console.error('Error saving note:', error);
                showError('Ошибка сохранения заметки');
            }
        }

        // Создание заметки (PUT)
        async function createNote() {
            const title = document.getElementById('newNoteTitle').value.trim();
            if (!title) return;

            try {
                const response = await fetch('/dashboard/note', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title,
                        content: '',
                        folder_id: currentParentFolderId || null
                    })
                });

                if (!response.ok) throw new Error('Ошибка создания');

                closeNewNoteModal();
                loadTree();
            } catch (error) {
                console.error('Error creating note:', error);
                showError('Ошибка создания заметки');
            }
        }

        // Создание папки (PUT)
        async function createFolder() {
            const title = document.getElementById('newFolderTitle').value.trim();
            if (!title) return;

            try {
                const response = await fetch('/dashboard/folder', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        title
                    })
                });

                if (!response.ok) throw new Error('Ошибка создания');

                closeNewFolderModal();
                loadTree();
            } catch (error) {
                console.error('Error creating folder:', error);
                showError('Ошибка создания папки');
            }
        }

        // Перемещение элемента (ТОЛЬКО folder_id)
        async function moveItem(itemId, itemType, parentId) {
            try {
                const endpoint = itemType === 'folder' 
                    ? `/dashboard/folder/${itemId}`
                    : `/dashboard/note/${itemId}`;

                const response = await fetch(endpoint, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        folder_id: parentId
                    })
                });

                if (!response.ok) throw new Error('Ошибка перемещения');

                loadTree();
            } catch (error) {
                console.error('Error moving item:', error);
                showError('Ошибка перемещения');
            }
        }

        // Удаление
        function showDeleteConfirm(item) {
            deleteCallback = () => deleteItem(item);
            document.getElementById('deleteMessage').textContent = 
                `Вы уверены, что хотите удалить ${item.type === 'folder' ? 'папку' : 'заметку'} "${item.title}"?`;
            document.getElementById('confirmDeleteModal').classList.add('active');
        }

        function closeConfirmDelete() {
            document.getElementById('confirmDeleteModal').classList.remove('active');
            deleteCallback = null;
        }

        function confirmDelete() {
            if (deleteCallback) deleteCallback();
            closeConfirmDelete();
        }

        async function deleteItem(item) {
            try {
                const endpoint = item.type === 'folder'
                    ? `/dashboard/folder/${item.id}`
                    : `/dashboard/note/${item.id}`;

                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (!response.ok) throw new Error('Ошибка удаления');

                if (currentItem && currentItem.id === item.id) {
                    currentItem = null;
                    document.getElementById('contentBody').innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">📝</div>
                            <div class="empty-title">Brain Notes</div>
                            <div>Выберите заметку для просмотра</div>
                        </div>
                    `;
                }
                loadTree();
            } catch (error) {
                console.error('Error deleting item:', error);
                showError('Ошибка удаления');
            }
        }

        function deleteCurrentNote() {
            if (currentItem && currentItem.type === 'note') {
                showDeleteConfirm(currentItem);
            }
        }

        // Модальные окна
        function closeNewNoteModal() {
            document.getElementById('newNoteModal').classList.remove('active');
            document.getElementById('newNoteTitle').value = '';
        }

        function closeNewFolderModal() {
            document.getElementById('newFolderModal').classList.remove('active');
            document.getElementById('newFolderTitle').value = '';
        }

        document.getElementById('newNoteBtn').onclick = () => {
            document.getElementById('newNoteModal').classList.add('active');
            document.getElementById('newNoteTitle').focus();
        };

        document.getElementById('newFolderBtn').onclick = () => {
            document.getElementById('newFolderModal').classList.add('active');
            document.getElementById('newFolderTitle').focus();
        };

        // Выход
        async function logout() {
            stopTokenRefresh();
            try {
                await fetch('/auth/logout', { method: 'POST', credentials: 'include' });
                window.location.href = '/';
            } catch (error) {
                window.location.href = '/';
            }
        }

        document.getElementById('logoutBtn').onclick = logout;

        // Утилиты
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showError(message) {
            alert(message);
        }

        // Инициализация
        document.addEventListener('DOMContentLoaded', () => {
            loadTree();
            startTokenRefresh();
        });

        window.addEventListener('beforeunload', stopTokenRefresh);

        // Закрытие модальных окон по клику вне
        document.getElementById('newNoteModal').onclick = (e) => {
            if (e.target.id === 'newNoteModal') closeNewNoteModal();
        };
        document.getElementById('newFolderModal').onclick = (e) => {
            if (e.target.id === 'newFolderModal') closeNewFolderModal();
        };
        document.getElementById('confirmDeleteModal').onclick = (e) => {
            if (e.target.id === 'confirmDeleteModal') closeConfirmDelete();
        };

        // Enter в модальных окнах
        document.getElementById('newNoteTitle').onkeypress = (e) => {
            if (e.key === 'Enter') createNote();
        };
        document.getElementById('newFolderTitle').onkeypress = (e) => {
            if (e.key === 'Enter') createFolder();
        };
    </script>
</body>
</html>